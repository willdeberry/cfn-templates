---
AWSTemplateFormatVersion: "2010-09-09"
Description: Template for standing up minecraft server

Parameters:
  UbuntuArmAMI:
    Type: "AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>"
    Default: /aws/service/canonical/ubuntu/server-minimal/22.04/stable/current/arm64/hvm/ebs-gp2/ami-id

Resources:
  Subnet:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone: us-east-1c
      CidrBlock: 10.0.0.16/28
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: Minecraft
      VpcId: !ImportValue main-vpc-id

  RouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      Tags:
        - Key: Name
          Value: minecraft-routeTable
      VpcId: !ImportValue main-vpc-id

  Route:
    Type: AWS::EC2::Route
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !ImportValue main-igw
      RouteTableId: !Ref RouteTable

  SubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref RouteTable
      SubnetId: !Ref Subnet

  SubnetToNACL:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Properties:
      NetworkAclId: !ImportValue main-nacl
      SubnetId: !Ref Subnet

  EIPAssociation:
    Type: AWS::EC2::EIPAssociation
    Properties:
      AllocationId: !ImportValue minecraft-eip-allocationid
      InstanceId: !Ref EC2

  EC2:
    Type: AWS::EC2::Instance
    CreationPolicy:
      ResourceSignal:
        Timeout: PT5M
    Metadata:
      AWS::CloudFormation::Init:
        configSets:
          all:
            - setup
            - config
            - cleanup
        setup:
          commands:
            createUser:
              command: useradd --shell /bin/bash --home-dir /home/will will
            updateGroups:
              command: usermod -a -G docker,plugdev,sudo will
        config:
          files:
            /etc/sudoers.d/will:
              content: '%will ALL=(ALL:ALL) NOPASSWD: ALL'
              mode: 440
              owner: root
              group: root
            /home/will/.ssh/authorized_keys:
              content: 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIANk7ASLutRd1SH/+INoodEm1l07Baj16cQBYtajr6p1'
              mode: 600
              owner: will
              group: will
        cleanup:
          commands:
            fixPerms:
              command: 'chown -R will.will /home/will'
    Properties:
      AvailabilityZone: !GetAtt Subnet.AvailabilityZone
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            DeleteOnTermination: true
            Encrypted: false
            VolumeSize: 20
            VolumeType: gp2
      IamInstanceProfile: !Ref StoragePermInstanceProfile
      ImageId: !Ref UbuntuArmAMI
      InstanceType: t4g.medium
      KeyName: ssh-ed25519
      SecurityGroupIds:
        - !ImportValue main-minecraftsg
      SubnetId: !Ref Subnet
      Tags:
        - Key: Name
          Value: Minecraft
      Tenancy: default
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash

          apt update
          apt install -y --no-install-recommends python3-pip awscli docker.io docker-compose
          python3 -m pip install https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-py3-latest.tar.gz
          /usr/local/bin/cfn-init -v --stack ${AWS::StackName} --resource EC2 --configsets all --region ${AWS::Region}
          /usr/local/bin/cfn-signal --exit-code $? --stack ${AWS::StackName} --resource EC2 --region ${AWS::Region}

  StorageAccessPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: S3Admin
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - s3:*
            Resource:
              - !Sub '${Storage.Arn}/*'
              - !GetAtt Storage.Arn
      Roles:
        - !Ref StorageRole

  StorageRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                ec2.amazonaws.com
            Action:
              - sts:AssumeRole
      Tags:
        - Key: Name
          Value: minecraft-s3-fullAccess

  StoragePermInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref StorageRole
